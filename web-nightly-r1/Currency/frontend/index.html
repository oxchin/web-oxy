<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP will be set dynamically by JavaScript based on environment -->
    <!-- Fonts and icons are loaded via JavaScript modules for CSP compliance -->
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="assets/kconvert-logo-orig.webp" type="image/webp">
    <title>A simple & fast currency converter</title>
</head>

<body>
    <div class="container container--1">
        <!-- Animated Logo Header -->
        <div class="brand">
            <div class="brand-ring ring-outer"></div>
            <div class="brand-ring ring-gold"></div>
            <div class="brand-ring ring-inner"></div>
            <div class="brand-logo">
                <img src="assets/kconvert-logo-orig.webp" alt="Kconvert logo" />
            </div>
        </div>
        <h2 class="app-title">Kconvert App</h2>
        <p class="app-subtitle">Simple professional currency converter with real-time rates</p>
        
        <!-- Feature Icons Section -->
        <div class="features-section">
            <div class="feature-item">
                <div class="feature-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <span class="feature-text">Real-time Rates</span>
            </div>
            <div class="feature-item">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="feature-text">Market Insights</span>
            </div>
            <div class="feature-item">
                <div class="feature-icon">
                    <i class="fas fa-palette"></i>
                </div>
                <span class="feature-text">Modern Design</span>
            </div>
        </div>
        
        <div class="version-badge">Stellar Edition 1.5</div>
        
        <!-- Fire Arrow Scroll Indicator -->
        <div class="gem-scroll-indicator">
            <div class="gem-blue">
                <div class="gem-core"></div>
            </div>
        </div>
    </div>

    <!-- Second Container: Calc engine-->
    <div class="container container--2">
        <h2 class="section-title">Currency Converter</h2>
      <div class="A">
          <p>Amount</p>
      </div>
      <form id="converter-form">
          <div class="amount">
              <input type="text" id="amount-input" class="form1"
              aria-label="Amount to convert" placeholder="Enter amount" autocomplete="off">
          </div>

          <div class="convert-box">
              <div class="from">
                  <p>From</p>
                  <div class="search-input-container" data-type="from">
                      <img id="from-flag" src="/node_modules/country-flag-icons/3x2/US.svg" alt="US Dollar flag" class="flag-indicator">
                      <input type="text" class="currency-search from-search form2" 
                             placeholder="USD - United States Dollar" 
                             aria-label="Search from currency"
                             data-currency="USD"
                             data-full-name="USD - United States Dollar"
                             autocomplete="off"
                             readonly>
                      <div class="search-suggestions from-suggestions" style="display: none;"></div>
                  </div>
              </div>
              <div class="reverse" aria-label="Swap currencies">
                  <i class="fas fa-exchange-alt"></i>
              </div>
              <div class="to">
                  <p>To</p>
                  <div class="search-input-container" data-type="to">
                      <img id="to-flag" src="/node_modules/country-flag-icons/3x2/SG.svg" alt="Singapore Dollar flag" class="flag-indicator">
                      <input type="text" class="currency-search to-search form3" 
                             placeholder="SGD - Singapore Dollar" 
                             aria-label="Search to currency"
                             data-currency="SGD"
                             data-full-name="SGD - Singapore Dollar"
                             autocomplete="off"
                             readonly>
                      <div class="search-suggestions to-suggestions" style="display: none;"></div>
                  </div>
              </div>
              <div class="result" aria-live="polite">Ready to convert</div>
              <!-- Inline help icon (opens floating modal with instructions) -->
              <span id="help-icon" class="info-help-icon" aria-label="Show usage help" tabindex="0">?</span>
              <button type="submit" id="convert-button"><i class="fas fa-arrow-right"></i><span>Convert</span></button>
              <button type="reset" id="reset-button"><i class="fas fa-rotate-left"></i><span>Reset</span></button> <!-- Keep inside container -->
          </div>
      </form>
  </div>

    <!-- Third Container: Chart Graphics -->
    <div class="container chart-container container--3">
        <h2 class="section-title">Exchange Rate Chart</h2>
        
        <!-- Chart Type Controls -->
        <div class="chart-type-controls">
            <button class="chart-type-btn active" data-type="area">
                <i class="fas fa-chart-area"></i>
                <span>Area</span>
            </button>
            <button class="chart-type-btn" data-type="line">
                <i class="fas fa-chart-line"></i>
                <span>Line</span>
            </button>
            <button class="chart-type-btn" data-type="bar">
                <i class="fas fa-chart-bar"></i>
                <span>Change %</span>
            </button>
        </div>
        
        <!-- Time Range Controls -->
        <div class="chart-controls">
            <button class="time-range-btn active" data-range="12H">12H</button>
            <button class="time-range-btn" data-range="1D">1D</button>
            <button class="time-range-btn" data-range="1W">1W</button>
            <button class="time-range-btn" data-range="1M">1M</button>
            <button class="time-range-btn" data-range="1Y">1Y</button>
            <button class="time-range-btn" data-range="2Y">2Y</button>
            <button class="time-range-btn" data-range="5Y">5Y</button>
            <button class="time-range-btn" data-range="10Y">10Y</button>
        </div>
        <div class="chart-wrapper">
            <canvas id="exchangeRateChart"></canvas>
        </div>
        <div class="chart-info">
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span class="live-text">LIVE</span>
            </div>
            <div class="chart-currency-pair">
                <span class="chart-from">0 USD =</span>
                <span class="chart-to">0.000000 SGD</span>
            </div>
          
        </div>
    </div>

    <!-- New Container: What is Chart? -->
    <div class="container chart-info-container container--3-5">
        <h2 class="section-title">What is Chart?</h2>
        <div class="section-content">
            <p>A currency exchange rate chart is a powerful visual representation that displays the historical price movements and trends of one currency relative to another over specific time periods. These charts are essential tools for traders, investors, and businesses engaged in international commerce, providing critical insights into market volatility, price patterns, and economic indicators. Modern exchange rate charts utilize advanced charting technologies including area charts for trend visualization, line charts for precise price tracking, and percentage change bars for comparative analysis. By examining these visual data representations, users can identify market trends, make informed financial decisions, and understand the complex dynamics of global currency markets influenced by economic policies, geopolitical events, and market sentiment.</p>
        </div>
    </div>

    <!-- Four Container: What is converter? -->
    <div class="container info-container container--4">
        <h2 class="section-title">What is converter?</h2>
        <div class="section-content">
            <p>A currency converter is an essential financial tool that allows users to calculate the equivalent value of one currency in terms of another currency. This powerful utility uses real-time exchange rates from global financial markets to provide accurate conversions between different international currencies. Whether you're planning international travel, conducting business across borders, making online purchases from foreign retailers, or simply staying informed about global economic trends, a currency converter serves as your gateway to understanding monetary values worldwide. Modern currency converters leverage advanced APIs and financial data sources to ensure precision and reliability, making complex foreign exchange calculations accessible to everyone from casual travelers to professional traders and international business professionals.</p>
        </div>
    </div>

    <!-- Economics Learning Container -->
    <div class="container economics-container container--4-5">
        <h2 class="section-title">Learn Economics</h2>
        <div class="section-content">
            <p>Expand your understanding of global economics and financial markets with these comprehensive educational resources from Wikipedia.</p>
            
            <div class="economics-grid">
                <div class="economics-card">
                    <div class="economics-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="economics-content">
                        <h3 class="economics-title">Supply and Demand</h3>
                        <p class="economics-desc">Learn about the fundamental economic principle that determines prices in market economies.</p>
                        <a href="https://en.wikipedia.org/wiki/Supply_and_demand" target="_blank" rel="noopener" class="economics-link">
                            <i class="fas fa-external-link-alt"></i>
                            Learn on Wikipedia
                        </a>
                    </div>
                </div>
                
                <div class="economics-card">
                    <div class="economics-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="economics-content">
                        <h3 class="economics-title">Inflation Economics</h3>
                        <p class="economics-desc">Understand how inflation affects currency values and purchasing power in global markets.</p>
                        <a href="https://en.wikipedia.org/wiki/Inflation" target="_blank" rel="noopener" class="economics-link">
                            <i class="fas fa-external-link-alt"></i>
                            Learn on Wikipedia
                        </a>
                    </div>
                </div>
                
                <div class="economics-card">
                    <div class="economics-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="economics-content">
                        <h3 class="economics-title">Foreign Exchange Market</h3>
                        <p class="economics-desc">Explore the world's largest financial market where currencies are traded globally.</p>
                        <a href="https://en.wikipedia.org/wiki/Foreign_exchange_market" target="_blank" rel="noopener" class="economics-link">
                            <i class="fas fa-external-link-alt"></i>
                            Learn on Wikipedia
                        </a>
                    </div>
                </div>
                
                <div class="economics-card">
                    <div class="economics-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="economics-content">
                        <h3 class="economics-title">Monetary Policy</h3>
                        <p class="economics-desc">Discover how central banks control money supply and interest rates to influence economies.</p>
                        <a href="https://en.wikipedia.org/wiki/Monetary_policy" target="_blank" rel="noopener" class="economics-link">
                            <i class="fas fa-external-link-alt"></i>
                            Learn on Wikipedia
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Five Container: About Kconvert App -->
    <div class="container about-container container--5">
        <h2 class="section-title">About the Kconvert app</h2>
        <div class="section-content">
            <p>Is an app for converter, not like traditional other, this project apps to make simple but modern look that function, this project leader by Team 6. with license GPL-3.0 you can use, modify, and distribute this software freely. The project emphasizes clean design principles, user-friendly interfaces, and reliable functionality while maintaining open-source accessibility for developers worldwide.</p>
            
            <div class="project-info">
                <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <span class="info-label">Version:</span>
                    <span class="info-value">Stellar-1.5</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-code-branch"></i>
                    <span class="info-label">Type Apps:</span>
                    <span class="info-value">Creativity Project</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-wrench"></i>
                    <span class="info-label">Status:</span>
                    <span class="info-value">Maintenance</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-balance-scale"></i>
                    <span class="info-label">License:</span>
                    <span class="info-value">GPL-3.0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Accuracy Warning Container -->
    <div class="container warning-container container--6">
        <div class="warning-content">
            <div class="warning-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="warning-text">
                <h3 class="warning-title">Data Accuracy Notice</h3>
                <p class="warning-message">Please be aware that exchange rates and financial data provided by this application may occasionally be inaccurate or delayed. Market conditions change rapidly, and technical issues may affect data quality. Always verify critical financial information with official sources before making important financial decisions. This tool is intended for informational purposes and should not be used as the sole basis for financial transactions.</p>
            </div>
        </div>
    </div>

    <!-- Currency Search Modal -->
    <div class="search-modal-backdrop" id="search-backdrop"></div>
    <div class="currency-search-modal" id="currency-modal">
        <div class="search-modal-header">
            <input type="text" class="search-modal-input" id="modal-search-input" placeholder="Search currency (e.g. US, America, USD)..." autocomplete="off">
            <button class="modal-close-btn" id="modal-close-btn" aria-label="Close currency search">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-modal-list" id="modal-currency-list">
            <!-- Currency list will be populated by JavaScript -->
        </div>
    </div>

    <!-- Glass Notify Modal -->
    <dialog id="notify-modal" class="glass-modal">
        <div class="modal-content">
            <div class="modal-icon" aria-hidden="true"><i class="fa-solid fa-circle-question"></i></div>
            <div class="modal-text">
                <h3 id="modal-title">Warning</h3>
                <p id="modal-message">Something needs your attention.</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="modal-close">Close</button>
            </div>
        </div>
    </dialog>

    <!-- Footer Container -->
    <footer class="footer-container">
        <div class="footer-content">
            <p class="footer-text">&copy; 2025 Team 6. Licensed under <a class="gpl-link" href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank" rel="noopener">GPL-3.0</a>.</p>
        </div>
    </footer>

    <script type="module" src="./main.js"></script>
    <script>
      // Minimal modal close behavior to avoid blocking UX; main.js can extend this
      const modal = document.getElementById('notify-modal');
      const closeBtn = document.getElementById('modal-close');
      if (modal && closeBtn) {
        closeBtn.addEventListener('click', () => window.KconvertModal.close());
      }
      // Enhanced modal API with smooth transitions
      window.KconvertModal = {
        open({title = 'Notice', message = '', icon = 'question'} = {}) {
          document.getElementById('modal-title').textContent = title;
          document.getElementById('modal-message').textContent = message;
          const iconEl = document.querySelector('#notify-modal .modal-icon i');
          if (iconEl) {
            if (icon === 'check') {
              iconEl.className = 'fa-solid fa-circle-check';
            } else {
              iconEl.className = 'fa-solid fa-circle-question';
            }
          }
          modal.showModal();
          // Disable background scrolling
          document.body.style.overflow = 'hidden';
          document.documentElement.style.overflow = 'hidden';
        },
        close(){ 
          // Add closing animation
          modal.style.animation = 'modalSlideOut 0.3s ease-out forwards';
          setTimeout(() => {
            modal.close();
            modal.style.animation = '';
            // Restore background scrolling
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
          }, 300);
        }
      }

      // Currency Search Modal Functionality
      const currencyModal = document.getElementById('currency-modal');
      const searchBackdrop = document.getElementById('search-backdrop');
      const modalSearchInput = document.getElementById('modal-search-input');
      const modalCurrencyList = document.getElementById('modal-currency-list');
      let currentSearchType = null;
      let currentSearchInput = null;

      // Enhanced currency data with 100+ countries - loaded from backend
      let availableCurrencies = [];
      
      // Comprehensive country code mapping for 100+ currencies
      const currencyToCountry = {
        // Major currencies
        'USD': 'us', 'EUR': 'eu', 'GBP': 'gb', 'JPY': 'jp', 'AUD': 'au', 'CAD': 'ca',
        'CHF': 'ch', 'CNY': 'cn', 'SEK': 'se', 'NZD': 'nz', 'MXN': 'mx', 'SGD': 'sg',
        'HKD': 'hk', 'NOK': 'no', 'TRY': 'tr', 'RUB': 'ru', 'INR': 'in', 'BRL': 'br',
        'ZAR': 'za', 'KRW': 'kr', 'PLN': 'pl', 'THB': 'th', 'MYR': 'my', 'AED': 'ae',
        'SAR': 'sa', 'ILS': 'il', 'CLP': 'cl', 'COP': 'co', 'ARS': 'ar', 'TWD': 'tw',
        
        // European currencies
        'DKK': 'dk', 'CZK': 'cz', 'HUF': 'hu', 'RON': 'ro', 'BGN': 'bg', 'HRK': 'hr',
        'ISK': 'is', 'ALL': 'al', 'BAM': 'ba', 'MKD': 'mk', 'RSD': 'rs', 'MDL': 'md',
        
        // Asian currencies
        'PHP': 'ph', 'IDR': 'id', 'VND': 'vn', 'KHR': 'kh', 'LAK': 'la', 'MMK': 'mm',
        'BDT': 'bd', 'PKR': 'pk', 'NPR': 'np', 'LKR': 'lk', 'MVR': 'mv', 'BTN': 'bt',
        'AFN': 'af', 'UZS': 'uz', 'KZT': 'kz', 'KGS': 'kg', 'TJS': 'tj', 'TMT': 'tm',
        'MNT': 'mn', 'KPW': 'kp', 'JPY': 'jp',
        
        // Middle Eastern currencies
        'QAR': 'qa', 'KWD': 'kw', 'BHD': 'bh', 'OMR': 'om', 'JOD': 'jo', 'LBP': 'lb',
        'SYP': 'sy', 'IQD': 'iq', 'IRR': 'ir', 'GEL': 'ge', 'AMD': 'am', 'AZN': 'az',
        
        // African currencies
        'EGP': 'eg', 'NGN': 'ng', 'KES': 'ke', 'GHS': 'gh', 'MAD': 'ma', 'TND': 'tn',
        'DZD': 'dz', 'LYD': 'ly', 'ETB': 'et', 'UGX': 'ug', 'TZS': 'tz', 'RWF': 'rw',
        'XOF': 'sn', 'XAF': 'cm', 'MGA': 'mg', 'MUR': 'mu', 'SCR': 'sc', 'SZL': 'sz',
        'LSL': 'ls', 'BWP': 'bw', 'NAD': 'na', 'ZMW': 'zm', 'ZWL': 'zw', 'MWK': 'mw',
        'MZN': 'mz', 'AOA': 'ao', 'CVE': 'cv', 'GMD': 'gm', 'GNF': 'gn', 'LRD': 'lr',
        'SLL': 'sl', 'STD': 'st', 'CDF': 'cd', 'XPF': 'pf', 'DJF': 'dj', 'ERN': 'er',
        'SOS': 'so', 'SDP': 'sd', 'SSP': 'ss',
        
        // Eastern European & CIS
        'BYN': 'by', 'UAH': 'ua', 'GEL': 'ge', 'AMD': 'am', 'AZN': 'az',
        
        // Caribbean & Pacific
        'JMD': 'jm', 'TTD': 'tt', 'BBD': 'bb', 'BSD': 'bs', 'BZD': 'bz', 'XCD': 'ag',
        'HTG': 'ht', 'DOP': 'do', 'CUP': 'cu', 'KYD': 'ky', 'AWG': 'aw', 'ANG': 'cw',
        'SRD': 'sr', 'GYD': 'gy', 'FJD': 'fj', 'TOP': 'to', 'WST': 'ws', 'VUV': 'vu',
        'SBD': 'sb', 'PGK': 'pg', 'NCX': 'nc', 'XPF': 'pf',
      };
      
      // Load currencies from backend API
      async function loadCurrencies() {
        try {
          // Build from environment-driven base URL
          const base = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '') : '';
          const currenciesUrl = `${base}/api/currencies`;

          const response = await fetch(currenciesUrl, { headers: { 'Accept': 'application/json' } });
          const ct = response.headers.get('content-type') || '';
          if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status} ${response.statusText}: ${text.slice(0, 200)}...`);
          }
          if (!ct.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Expected JSON but received content-type '${ct}'. Body starts with: ${text.slice(0, 200)}...`);
          }
          const data = await response.json();
          availableCurrencies = data.currencies.map(currency => ({
            code: currency.code,
            name: currency.name,
            flag: currencyToCountry[currency.code] || 'un'
          }));
          console.log(`✅ Loaded ${availableCurrencies.length} currencies from backend`);
        } catch (error) {
          console.error('❌ Failed to load currencies from backend:', error);
          // Fallback to basic currencies
          availableCurrencies = [
            { code: 'USD', name: 'US Dollar', flag: 'us' },
            { code: 'EUR', name: 'Euro', flag: 'eu' },
            { code: 'GBP', name: 'British Pound', flag: 'gb' },
            { code: 'JPY', name: 'Japanese Yen', flag: 'jp' },
            { code: 'SGD', name: 'Singapore Dollar', flag: 'sg' }
          ];
        }
      }

      function openCurrencyModal(type, inputElement) {
        currentSearchType = type;
        currentSearchInput = inputElement;
        
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        
        currencyModal.style.display = 'flex';
        searchBackdrop.style.display = 'block';
        modalSearchInput.value = '';
        modalSearchInput.focus();
        renderCurrencyList(availableCurrencies);
      }

      function closeCurrencyModal() {
        // Restore body scrolling when modal is closed
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        currencyModal.style.display = 'none';
        searchBackdrop.style.display = 'none';
        currentSearchType = null;
        currentSearchInput = null;
      }

      function renderCurrencyList(currencies) {
        modalCurrencyList.innerHTML = currencies.map((currency, index) => `
          <div class="suggestion-item" data-currency="${currency.code}" data-name="${currency.name}" data-flag="${currency.flag}" style="animation-delay: ${index * 0.02}s">
            <img class="suggestion-flag" src="/node_modules/country-flag-icons/3x2/${currency.flag.toUpperCase()}.svg" alt="${currency.name} flag" onerror="this.src='/node_modules/country-flag-icons/3x2/UN.svg'">
            <div class="suggestion-text">
              <div class="suggestion-code">${currency.code}</div>
              <div class="suggestion-name">${currency.name}</div>
            </div>
          </div>
        `).join('');
      }
      
      // Enhanced search functionality
      function searchCurrencies(query) {
        if (!query.trim()) {
          renderCurrencyList(availableCurrencies);
          return;
        }
        
        const filtered = availableCurrencies.filter(currency => 
          currency.code.toLowerCase().includes(query.toLowerCase()) ||
          currency.name.toLowerCase().includes(query.toLowerCase())
        );
        
        renderCurrencyList(filtered);
      }

      function selectCurrency(code, name, flag) {
        if (currentSearchInput) {
          const fullName = `${code} - ${name}`;
          currentSearchInput.value = fullName;
          currentSearchInput.setAttribute('data-currency', code);
          currentSearchInput.setAttribute('data-full-name', fullName);
          
          // Update flag
          const flagImg = currentSearchInput.parentElement.querySelector('.flag-indicator');
          if (flagImg) {
            flagImg.src = `/node_modules/country-flag-icons/3x2/${flag.toUpperCase()}.svg`;
            flagImg.alt = `${name} flag`;
          }
          
          // Update global currency variables and call main.js function
          if (window.CurrencyConverter && window.CurrencyConverter.selectCurrency) {
            const currency = { code: code, name: name, country: flag };
            const isFromInput = currentSearchType === 'from';
            console.log(`🔄 Modal selecting currency: ${code} for ${isFromInput ? 'FROM' : 'TO'}`);
            window.CurrencyConverter.selectCurrency(currency, isFromInput);
          } else {
            console.error('❌ window.CurrencyConverter.selectCurrency not available');
            // Fallback: directly update global variables
            if (currentSearchType === 'from') {
              window.currentFromCurrency = code;
            } else {
              window.currentToCurrency = code;
            }
            console.log(`🔄 Fallback: Set ${currentSearchType} currency to ${code}`);
          }
        }
        closeCurrencyModal();
      }

      // Event listeners
      document.addEventListener('click', (e) => {
        if (e.target.closest('.search-input-container') && currencyModal.style.display !== 'flex') {
          const container = e.target.closest('.search-input-container');
          const type = container.getAttribute('data-type');
          const input = container.querySelector('.currency-search');
          openCurrencyModal(type, input);
        }
        
        if (e.target.closest('.suggestion-item')) {
          const item = e.target.closest('.suggestion-item');
          const code = item.getAttribute('data-currency');
          const name = item.getAttribute('data-name');
          const flag = item.getAttribute('data-flag');
          selectCurrency(code, name, flag);
        }
        
        // ONLY allow closing via X button - block all other methods
        if (e.target.closest('.modal-close-btn')) {
          closeCurrencyModal();
        }
      });
      
      // Add search input event listener
      modalSearchInput.addEventListener('input', (e) => {
        searchCurrencies(e.target.value);
      });
      
      // Load currencies when page loads
      document.addEventListener('DOMContentLoaded', () => {
        loadCurrencies();
      });  
      
      // Prevent any other clicks from closing modal
      document.addEventListener('click', (e) => {
        if (currencyModal.style.display === 'flex') {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // Search functionality
      modalSearchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const filtered = sampleCurrencies.filter(currency => 
          currency.code.toLowerCase().includes(query) ||
          currency.name.toLowerCase().includes(query)
        );
        renderCurrencyList(filtered);
      });

      // Keyboard navigation - DISABLE ESC key closing
      document.addEventListener('keydown', (e) => {
        if (currencyModal.style.display === 'flex') {
          // Block ESC key from closing modal
          if (e.key === 'Escape') {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      // Auto-clean functionality for currency inputs
      document.addEventListener('focusin', (e) => {
        if (e.target.classList.contains('currency-search') && currencyModal.style.display !== 'flex') {
          const originalValue = e.target.getAttribute('data-full-name');
          e.target.setAttribute('data-original-value', originalValue || e.target.value);
          e.target.value = '';
          e.target.removeAttribute('readonly');
        }
      });

      document.addEventListener('focusout', (e) => {
        if (e.target.classList.contains('currency-search') && currencyModal.style.display !== 'flex') {
          if (!e.target.value.trim()) {
            const originalValue = e.target.getAttribute('data-original-value');
            e.target.value = originalValue || e.target.getAttribute('data-full-name') || '';
          }
          e.target.setAttribute('readonly', 'true');
        }
      });

      // Restrict all inputs when modal is open
      document.addEventListener('keydown', (e) => {
        if (currencyModal.style.display === 'flex') {
          // Only allow input in the modal search field and close button
          if (!e.target.closest('.currency-search-modal') && e.target.id !== 'modal-search-input' && !e.target.closest('.modal-close-btn')) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      document.addEventListener('input', (e) => {
        if (currencyModal.style.display === 'flex') {
          // Only allow input in the modal search field
          if (!e.target.closest('.currency-search-modal') && e.target.id !== 'modal-search-input') {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      // Block all touch/pointer events outside modal except X button
      document.addEventListener('touchstart', (e) => {
        if (currencyModal.style.display === 'flex') {
          if (!e.target.closest('.currency-search-modal') && !e.target.closest('.modal-close-btn')) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });

      document.addEventListener('pointerdown', (e) => {
        if (currencyModal.style.display === 'flex') {
          if (!e.target.closest('.currency-search-modal') && !e.target.closest('.modal-close-btn')) {
            e.preventDefault();
            e.stopPropagation();
          }
        }
      });
    </script>
</body>
</html>